# 虚拟电厂调度优化系统 (VPP Optimization System)

基于 oemof-solph 构建的虚拟电厂多能源资源协调调度优化系统，采用 CBC 求解器进行线性规划优化。

---

## 🌟 系统效果预览

![虚拟电厂调度优化效果展示](example/optimization_results.png)

---

## 🎯 项目概述

本项目是一个完整的虚拟电厂调度优化解决方案，旨在为虚拟电厂提供智能化的能源资源调度策略，实现多类型能源资源的协调运行和成本最优化。系统集成了**源网荷储**一体化的现代能源管理理念，支持可再生能源、传统发电、储能系统、可调负荷和电网交互的协同优化。

## 注意！！！
本项目采用的数据都是通过数据生成方式的虚拟数据，如果需要替换成真实数据可以参考生成代码进行替换。

### 核心功能
- **多能源建模**: 光伏、风电、燃气机组、储能系统、可调负荷、电网交互
- **智能调度**: 基于线性规划的最优调度策略，支持多种优化目标
- **多目标优化**: 支持成本最小化和利润最大化两种优化目标
- **多模式调度**: 提供6种不同的调度模式，满足不同应用场景
- **辅助服务**: 储能系统参与调频和旋转备用服务，提供系统灵活性和额外收入
- **需求响应**: 冷机、热机等可调负荷参与系统优化，提供需求侧灵活性
- **实时分析**: 完整的经济性和技术性能分析，包含辅助服务收益评估
- **可视化**: 丰富的图表和报告生成，支持辅助服务策略展示
- **配置化**: 灵活的YAML配置文件管理，支持辅助服务参数调整
- **交互式界面**: 提供友好的交互式模式选择界面

### 最新特性 ✨
- ✅ **多目标优化**: 新增利润最大化优化目标，支持成本最小化和利润最大化双重目标
- ✅ **交互式选择**: 智能化的交互式界面，支持优化目标和调度模式的灵活选择
- ✅ **模式对比**: 支持所有调度模式的对比分析，生成详细的对比报告
- ✅ **会话管理**: 新增会话上下文管理，自动组织和保存结果文件
- ✅ **辅助服务**: 储能参与调频和旋转备用服务，实现容量预留和辅助服务收入优化
- ✅ **可调负荷**: 冷机和热机可调负荷，支持需求侧响应
- ✅ **经济优化**: 综合考虑发电成本、储能成本、可调负荷成本和辅助服务收入
- ✅ **智能可视化**: 自动检测系统组件，动态生成相应图表包含辅助服务分析
- ✅ **完整报告**: 包含辅助服务和可调负荷分析的详细运行报告

## 🏗️ 系统架构

```
vpp_opt_test_qqder/
├── README.md                    # 项目文档
├── pyproject.toml              # 项目配置
├── main.py                     # 主程序入口
├── config/                     # 配置文件目录
│   ├── system_config.yaml     # 系统参数配置
│   └── solver_config.yaml     # 求解器配置
├── docs/                       # 项目文档
│   └── optimization_modeling.md # 优化建模详细说明
├── src/                        # 源代码目录
│   ├── __init__.py
│   ├── data/                   # 数据生成模块
│   │   ├── __init__.py
│   │   └── data_generator.py   # 负荷、光伏、风电、电价数据生成
│   ├── models/                 # 优化模型模块
│   │   ├── __init__.py
│   │   └── vpp_model.py        # oemof-solph能源系统建模
│   ├── solvers/                # 求解器模块
│   │   ├── __init__.py
│   │   └── optimization_solver.py # CBC求解器配置和优化求解
│   ├── analysis/               # 结果分析模块
│   │   ├── __init__.py
│   │   └── result_analyzer.py  # 经济性分析和性能指标计算
│   └── visualization/          # 可视化模块
│       ├── __init__.py
│       └── plot_generator.py   # 结果图表生成和报告
├── tests/                      # 测试文件
│   └── test_vpp_system.py     # 系统测试
├── examples/                   # 示例和演示
│   └── demo_optimization.py   # 简单演示
├── outputs/                    # 输出结果目录
│   ├── plots/                  # 图表输出
│   └── reports/                # 报告输出
├── logs/                       # 日志文件
├── cbc/                        # CBC求解器
│   └── bin/
│       └── cbc.exe            # CBC可执行文件
└── test_*.py                   # 功能测试脚本
```

## 🔧 技术栈

### 核心技术
- **优化引擎**: oemof-solph 0.5.0+ (开源能源系统建模框架)
- **求解器**: CBC (Coin-or Branch and Cut) 线性规划求解器
- **建模工具**: pyomo 6.6.0+ (数学建模语言)
- **数据处理**: pandas, numpy
- **可视化**: matplotlib, plotly
- **配置管理**: PyYAML
- **Python版本**: 3.12+

### 依赖包
```toml
oemof.solph>=0.5.0      # 能源系统建模
pyomo>=6.6.0            # 数学优化建模
psutil>=7.0.0           # 系统监控
PyYAML>=6.0             # 配置文件解析
scipy>=1.11.0           # 科学计算
matplotlib>=3.8.0       # 图表绘制
pandas>=2.1.0           # 数据分析
numpy>=1.26.0           # 数值计算
```

## 🚀 快速开始

### 1. 环境准备

```bash
# 克隆项目
git clone https://github.com/2308087369/Virtual-power-plants
cd vpp_opt_test_qqder

# 安装依赖（推荐使用uv）
uv pip install -e .

# 或使用pip
pip install -e .
```

### 2. 运行优化

#### 交互式模式（推荐）
```bash
# 运行交互式模式，可选择优化目标和调度模式
python main.py
```

#### 命令行模式
```bash
# 运行完整的虚拟电厂优化演示
python main.py --demo

# 运行指定调度模式
python main.py --mode=full_system

# 运行所有模式对比分析
python main.py --compare-all

# 列出所有可用调度模式
python main.py --list-modes

# 查看帮助信息
python main.py --help
```

#### 可用调度模式
- `renewable_storage`: 可再生能源+储能模式
- `adjustable_storage`: 可调负荷+储能模式  
- `traditional`: 传统模式（无辅助服务）
- `no_renewable`: 无可再生能源模式
- `storage_only`: 纯储能调度模式
- `full_system`: 完整系统模式

#### 优化目标选择
- `cost_minimization`: 成本最小化（默认）
- `profit_maximization`: 利润最大化

### 3. 测试功能

```bash
# 运行所有测试
python test_runner.py

# 运行基本功能测试
python test_runner.py --type basic

# 测试CBC求解器
python test_runner.py --type cbc

# 测试调度模式
python test_runner.py --type scheduling

# 测试优化目标
python test_runner.py --type objectives

# 测试可调负荷功能
python test_runner.py --type loads

# 测试辅助服务功能
python test_runner.py --type ancillary

# 测试完整流程
python test_runner.py --type flow

# 运行单元测试
python tests/test_vpp_system.py
```

### 4. 配置自定义

编辑配置文件来自定义系统参数：

**系统配置** (`config/system_config.yaml`):
```yaml
# 能源资源容量配置
energy_resources:
  photovoltaic:
    capacity_mw: 50          # 光伏装机容量
  wind:
    capacity_mw: 30          # 风电装机容量
  gas_turbine:
    capacity_mw: 100         # 燃气机组容量
  battery_storage:
    power_capacity_mw: 50    # 储能功率容量
    energy_capacity_mwh: 200 # 储能能量容量
    
    # 辅助服务配置
    ancillary_services:
      frequency_regulation:
        max_capacity_mw: 20     # 调频服务最大容量
        up_price_yuan_mw: 80     # 向上调频价格
        down_price_yuan_mw: 70   # 向下调频价格
        enable: true             # 启用调频服务
      spinning_reserve:
        max_capacity_mw: 15      # 备用服务最大容量
        up_price_yuan_mw: 60     # 向上备用价格
        down_price_yuan_mw: 50   # 向下备用价格
        enable: true             # 启用备用服务

# 可调负荷配置
adjustable_loads:
  chiller:
    rated_power_mw: 20       # 冷机额定功率
    operating_cost_yuan_mwh: 50  # 运行成本
  heat_pump:
    rated_power_mw: 15       # 热机额定功率
    operating_cost_yuan_mwh: 40  # 运行成本
```

**求解器配置** (`config/solver_config.yaml`):
```yaml
cbc_options:
  threads: 4               # 使用线程数
  timeLimit: 300           # 求解时间限制(秒)
  ratioGap: 0.01          # 最优性间隙(1%)
```

## 📊 主要组件

### 1. 发电资源 ⚡

#### 可再生能源
- **光伏发电**: 50MW装机，日间出力，成本5元/MWh
- **风力发电**: 30MW装机，全天候运行，成本8元/MWh

#### 传统发电
- **燃气机组**: 100MW装机，最小出力30%，成本600元/MWh

### 2. 储能系统 🔋
- **功率容量**: 50MW (充电/放电)
- **能量容量**: 200MWh
- **往返效率**: 90.25% (充电95% × 放电95%)
- **响应速度**: 毫秒级快速响应
- **辅助服务**: 参与调频和旋转备用服务，预留一定容量用于系统调节

### 3. 可调负荷 🏭

#### 冷机系统
- **额定功率**: 20MW
- **调节范围**: 30%-100%
- **制冷效率**: 85%
- **响应时间**: 5分钟
- **运行成本**: 50元/MWh

#### 热机系统
- **额定功率**: 15MW  
- **调节范围**: 20%-100%
- **制热系数**: COP=3.5
- **响应时间**: 3分钟
- **运行成本**: 40元/MWh

### 4. 电网交互 🏗️
- **最大购电**: 1000MW
- **最大售电**: 500MW
- **售电价格**: 95%市场电价
- **双向调节**: 支持购售电灵活切换

## 🎯 优化目标与约束

### 优化目标

系统支持两种优化目标，用户可根据实际需求选择：

#### 1. 成本最小化 (Cost Minimization)
以**总运行成本最小化**为目标，综合优化：
```
min: 发电成本 + 储能成本 + 可调负荷成本 + 电网交易成本 - 售电收入 - 辅助服务收入
```

#### 2. 利润最大化 (Profit Maximization)  
以**总利润最大化**为目标，等价于成本最小化的负值：
```
max: 售电收入 + 辅助服务收入 - 发电成本 - 储能成本 - 可调负荷成本 - 电网交易成本
```

> 💡 **提示**: 两种目标在数学上等价，但利润最大化模式更直观地体现了虚拟电厂的盈利能力，特别适合参与电力市场交易的场景。

### 主要约束
1. **电力平衡约束**: 供需实时平衡
2. **设备容量约束**: 各设备运行在额定范围内
3. **储能SOC约束**: 储能荷电状态限制
4. **机组爬坡约束**: 燃气机组最小出力约束
5. **可调负荷约束**: 冷热机调节范围约束
6. **辅助服务约束**: 储能容量预留和辅助服务互斥约束
7. **电网交易限制**: 购售电功率上限

### 📚 详细数学建模
> 📖 **完整的优化建模说明**: [优化建模文档](docs/optimization_modeling.md)
>
> 包含详细的目标函数、约束条件、决策变量等数学公式和建模方法说明。

## 📊 输出结果

系统会在 `outputs/` 目录下生成详细的分析报告：

### 单模式分析结果
```
outputs/{mode}_{objective}_{timestamp}/
├── optimization_results.csv      # 优化结果详细数据
├── economics_analysis.csv        # 经济性分析
├── technical_metrics.csv         # 技术指标统计
├── summary_report.txt            # 运行总结报告
└── optimization_results.png      # 可视化图表
```

### 多模式对比分析结果
```
outputs/
├── modes_comparison_{objective}_{timestamp}.txt    # 模式对比报告
└── {mode}_{objective}_{timestamp}/                 # 各模式详细结果
    ├── optimization_results.csv
    ├── economics_analysis.csv
    ├── technical_metrics.csv
    ├── summary_report.txt
    └── optimization_results.png
```

### 调度策略输出
- ⚡ **发电计划**: 各时段光伏、风电、燃气机组出力
- 🔋 **储能策略**: 充放电功率和SOC变化
- 🏭 **负荷调节**: 冷机、热机功率调节策略
- 🔌 **电网交易**: 购售电计划和交易量

### 分析报告
- 📊 **经济性分析**: 成本结构、收益分析、投资回报
- 📈 **技术指标**: 可再生能源渗透率、自给自足率、设备利用率
- 📋 **运行报告**: 详细的系统运行总结和建议

### 可视化图表
- 📉 **发电资源出力曲线**
- ⚖️ **负荷与供应平衡图**
- 🔋 **储能充放电策略图**
- 🏭 **可调负荷运行状态图**
- 💰 **电价变化和成本结构图**

## 📊 典型运行结果

基于24小时优化调度的典型结果：

### 能源供需结构
- **总负荷需求**: 1,259.8 MWh
- **可再生能源发电**: 665.8 MWh (49.1%渗透率)
- **可调负荷参与**: 207.0 MWh (16.4%参与率)
- **辅助服务容量**: 33.5 MW (67.1%参与率)
- **自给自足率**: 100%

### 经济性指标

#### 成本最小化模式
- **净运行成本**: 109,805元
- **辅助服务收入**: 49,450元
- **平均供电成本**: 87.16元/MWh
- **辅助服务收入占比**: 13.7%
- **年化运行成本**: 约4,000万元

#### 利润最大化模式
- **净运营成本**: -14,121 至 122,933 元/天（负值表示盈利）
- **平均电力成本**: -224 至 1,952 元/MWh
- **最优模式**: renewable_storage（可再生能源+储能）
- **盈利能力排序**: renewable_storage > storage_only > traditional > adjustable_storage > full_system > no_renewable

### 技术指标
- **可再生能源利用率**: 高效消纳
- **辅助服务提供能力**: 向下调频 19.2MW、向下备用 14.4MW
- **负荷响应能力**: 35MW可调容量
- **电网交易平衡**: 净售电672MWh

### 模式对比洞察
- **可再生能源+储能**: 通过售电和储能套利实现盈利
- **纯储能模式**: 主要通过电价差套利获得收益
- **传统模式**: 燃气发电成本较高，盈利能力有限
- **无可再生能源**: 成本最高，经济性最差

### 📊 关键技术指标

通过可视化结果可以清晰看到：
- **🌞 光伏发电**: 日间高效发电，峰值达到额定容量
- **💨 风力发电**: 全天候稳定出力，提供基础电力供应
- **⚡ 燃气机组**: 灵活调节，在可再生能源不足时及时补充
- **🔋 储能系统**: 削峰填谷，优化电力供需匹配
- **🏭 可调负荷**: 冷机和热机智能参与需求侧响应
- **🔌 电网交互**: 双向功率流，实现经济优化运行

> 💡 **提示**: 图表数据基于真实的优化算法计算结果，反映了虚拟电厂在实际运行中的调度策略和经济效益。

## 🔍 使用场景

### 适用领域
- 🏭 **工业园区**: 多能源协调调度和成本优化，通过利润最大化模式实现园区能源系统盈利
- 🏢 **商业综合体**: 冷热电联供系统优化，支持成本最小化和利润最大化双重目标
- 🌆 **智慧城市**: 区域能源管理和需求响应，优化城市能源经济效益
- ⚡ **电力市场**: 虚拟电厂聚合资源参与市场交易，辅助服务市场竞价策略
- 🔬 **科研院所**: 能源系统优化算法研究，多目标优化建模验证

### 典型用户
- **虚拟电厂运营商**: 制定最优调度策略，选择成本最小化或利润最大化目标
- **能源管理系统开发者**: 算法验证和系统集成，多目标优化功能开发
- **电力市场参与者**: 交易策略制定和风险评估，售电收益最大化
- **工业用户**: 能源成本控制和需求侧管理，通过可调负荷参与辅助服务获得收益

### 应用场景对比

#### 成本最小化模式
- **工业园区**: 降低园区整体用能成本，优化能源采购策略
- **电力市场**: 优化购电策略，降低电力采购成本
- **可再生能源**: 风光储一体化运行，降低新能源弃电成本
- **需求响应**: 负荷侧资源聚合调度，峰谷电价套利

#### 利润最大化模式
- **工业园区**: 通过售电和辅助服务创收，实现园区能源系统盈利
- **电力市场**: 辅助服务市场竞价策略，现货市场交易优化，容量市场参与决策
- **可再生能源**: 新能源发电售电收益最大化，储能套利策略优化
- **需求响应**: 需求响应服务收益最大化，电网调峰辅助服务创收

#### 虚拟电厂运营决策
- **投资决策**: 对比不同配置方案的经济性表现
- **运营策略**: 根据市场环境选择最优调度模式和优化目标
- **风险评估**: 分析不同模式下的盈利能力和风险水平

## 🛠️ 开发指南

### 扩展新的可调资源

1. **配置文件扩展**:
```yaml
# config/system_config.yaml
adjustable_loads:
  new_device:
    rated_power_mw: 10
    operating_cost_yuan_mwh: 30
```

2. **模型组件添加**:
```python
# src/models/vpp_model.py
def _create_adjustable_loads(self):
    # 添加新设备的建模逻辑
    new_device = solph.components.Sink(...)
```

3. **结果分析更新**:
```python
# src/analysis/result_analyzer.py
# 添加新设备的结果提取和分析
```

### 自定义优化目标

可以通过修改oemof-solph模型来实现不同的优化目标：
- 碳排放最小化
- 可再生能源利用率最大化
- 峰谷差最小化
- 多目标权衡优化

## ⚠️ 注意事项

### 系统要求
- **操作系统**: Windows 10+, Linux, macOS
- **Python版本**: 3.12或更高
- **内存**: 建议8GB以上
- **处理器**: 多核处理器，支持并行计算

### 求解器配置
- CBC求解器已包含在项目中 (`cbc/bin/cbc.exe`)
- 大规模问题建议使用商业求解器（Gurobi, CPLEX）
- 求解时间可通过配置文件调整

### 性能优化建议
- 适当调整时间段数量和模型复杂度
- 使用多线程求解提升性能
- 监控内存使用，避免内存不足

## 🐛 故障排除

### 常见问题

**1. CBC求解器找不到**
```bash
# 检查CBC路径
ls cbc/bin/cbc.exe

# 重新安装依赖
uv pip install -e .
```

**2. 求解失败**
- 检查数据有效性
- 调整求解器参数
- 查看日志文件 `logs/solver.log`

**3. 内存不足**
- 减少优化时间段
- 简化模型约束
- 增加虚拟内存

## 📝 许可证

MIT License - 详见 [LICENSE](LICENSE) 文件
